From 1a2b3c4d5e6f7g8h9i0j1k2l3m4n5o6p7q8r9s0t Mon Sep 17 00:00:00 2001
From: dwl-user <user@example.com>
Date: Thu, 15 Aug 2025 13:15:00 +0000
Subject: [PATCH] tagmon: preserve client tags when moving monitors

---
 de/.local/share/dwl/dwl.c | 6 ++++++
 1 file changed, 6 insertions(+), 3 deletions(-)

diff --git a/de/.local/share/dwl/dwl.c b/de/.local/share/dwl/dwl.c
index 69df6cd..9e772a4 100644
--- a/de/.local/share/dwl/dwl.c
+++ b/de/.local/share/dwl/dwl.c
@@ -3191,9 +3191,9 @@ tag(const Arg *arg)
 void
 tagmon(const Arg *arg)
 {
-       Client *sel = focustop(selmon);
-       if (sel)
-               setmon(sel, dirtomon(arg->i), 0);
void
tagmon(const Arg *arg)
{
+    Client *sel = focustop(selmon);
+    Monitor *orig, *dest;
+    unsigned int orig_tags;
+    Client *c;
+    int hasclients = 0;
+
+    if (!sel)
+        return;
+
+    orig = selmon;                          /* source monitor */
+    orig_tags = orig->tagset[orig->seltags];/* save its current tagset */
+    dest = dirtomon(arg->i);
+
+    /* move client to new monitor with its tags */
+    setmon(sel, dest, sel->tags);
+
+    /* switch destination monitor to the client's tags (via view) */
+    if (sel->tags) {
+        Arg a = {.ui = sel->tags};
+        selmon = dest;
+        view(&a);
+        selmon = orig; /* restore */
+    }
+
+    /* check if origin monitor still has any clients on its original view */
+    wl_list_for_each(c, &clients, link) {
+        if (c->mon == orig && (c->tags & orig_tags)) {
+            hasclients = 1;
+            break;
+        }
+    }
+
+    /* if none remain, switch origin monitor to tag 1 (via view) */
+    if (!hasclients) {
+        Arg a = {.ui = 1 << 0};
+        selmon = orig;
+        view(&a);
+    }
+}
 }

 void
--
2.40.0

